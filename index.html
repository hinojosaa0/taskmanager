<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task Manager – Planner</title>
  <style>
    :root {
      --bg:#0f172a; --card:#111827; --muted:#1f2937; --text:#e5e7eb; --sub:#9ca3af;
      --primary:#4f46e5; --accent:#22c55e; --warn:#f59e0b; --danger:#ef4444; --blue:#60a5fa;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
    .app{display:grid;grid-template-rows:auto 1fr auto;min-height:100svh}
    header{display:flex;gap:.75rem;align-items:center;padding:.75rem 1rem;border-bottom:1px solid var(--muted);position:sticky;top:0;background:linear-gradient(180deg,var(--bg),rgba(15,23,42,.95));backdrop-filter:saturate(180%) blur(6px);z-index:10}
    header h1{font-size:1.05rem;margin:0;font-weight:700}
    header .grow{flex:1}
    header input[type="search"]{width:100%;max-width:420px;padding:.55rem .8rem;border-radius:.6rem;border:1px solid var(--muted);background:#0b1222;color:var(--text)}
    .container{display:grid;grid-template-columns:260px 1fr;gap:12px;padding:12px}
    @media (max-width:900px){.container{grid-template-columns:1fr}.sidebar{display:none}}
    .sidebar{display:grid;gap:12px}
    .card{background:var(--card);border:1px solid var(--muted);border-radius:14px}
    .card h3{margin:0;padding:12px 12px 0;font-size:.9rem;color:var(--sub)}
    .card .content{padding:12px}
    .projects{display:grid;gap:6px;max-height:45vh;overflow:auto;padding:8px}
    .project{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border-radius:10px;background:#0b1222;border:1px solid #0e162b;cursor:pointer}
    .project.active{outline:2px solid var(--primary)}
    .project small{color:var(--sub)}
    .btn{appearance:none;border:1px solid var(--muted);background:#0b1222;color:var(--text);padding:.5rem .8rem;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:transparent}
    .btn.full{width:100%}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;border-bottom:1px solid var(--muted);padding:0 8px}
    .tab{padding:.5rem .8rem;border-radius:10px 10px 0 0;background:#0b1222;border:1px solid var(--muted);border-bottom:none;cursor:pointer}
    .tab.active{background:var(--primary)}
    textarea{width:100%;min-height:60px;background:#0b1222;color:var(--text);border:1px solid var(--muted);border-radius:10px;padding:.6rem}
    .list{display:grid;gap:8px;max-height:45vh;overflow:auto}
    .item{display:grid;grid-template-columns:1fr 100px 120px 80px;gap:8px;padding:10px;border:1px solid var(--muted);border-radius:12px;background:#0b1222}
    .badge{padding:.2rem .5rem;border-radius:999px;font-size:.7rem}
    .gantt-wrap{overflow:auto;border:1px solid var(--muted);border-radius:12px;background:#0b1222}
    .today{stroke:var(--danger);stroke-width:1.5}
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Task Manager</h1>
    <div class="grow"></div>
    <input id="search" type="search" placeholder="Buscar (⌘/Ctrl+K)" />
    <button class="btn" id="exportBtn">Exportar</button>
    <input id="importInput" type="file" accept="application/json" style="display:none" />
    <button class="btn" id="importBtn">Importar</button>
  </header>

  <div class="container">
    <aside class="sidebar">
      <div class="card">
        <h3>Proyectos</h3>
        <div class="content">
          <div class="row" style="margin-bottom:8px">
            <input id="newProjectName" placeholder="Nuevo proyecto" />
            <button class="btn primary" id="addProject">Agregar</button>
          </div>
          <div class="projects" id="projectList"></div>
        </div>
      </div>

      <div class="card">
        <h3>Notas del proyecto</h3>
        <div class="content">
          <textarea id="projectNotes" placeholder="Notas rápidas del proyecto..."></textarea>
          <div class="row" style="margin-top:8px;justify-content:space-between">
            <small id="notesSaved" style="color:var(--sub)">Auto-guardado</small>
            <button class="btn" id="clearNotes">Limpiar</button>
          </div>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="tabs">
        <button class="tab active" data-tab="capture">Captura</button>
        <button class="tab" data-tab="gantt">Gantt</button>
      </div>

      <section class="section active" id="capture">
        <div class="card">
          <h3>Alta de ítems</h3>
          <div class="content">
            <form id="itemForm">
              <input id="fTitle" placeholder="Título o tarea" />
              <select id="fType">
                <option>Task</option>
                <option>Meeting</option>
                <option>Deliverable</option>
              </select>
              <input id="fPs" type="date" placeholder="Inicio" />
              <input id="fPe" type="date" placeholder="Fin" />
              <button class="btn primary" type="submit">Guardar</button>
            </form>
          </div>
        </div>
        <div class="card">
          <h3>Listado</h3>
          <div class="content list" id="itemList"></div>
        </div>
      </section>

      <section class="section" id="gantt">
        <div class="card">
          <h3>Gantt Consolidado</h3>
          <div class="content gantt-wrap">
            <svg id="ganttSvg" width="100%" height="400"></svg>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>

<!-- Firebase integration -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyByXG4mk3yaRKNj0Rj_1YhkT4ptJlcKVZE",
    authDomain: "taskmanager-63481.firebaseapp.com",
    projectId: "taskmanager-63481",
    storageBucket: "taskmanager-63481.appspot.com",
    messagingSenderId: "647094080600",
    appId: "1:647094080600:web:7e088d362e7edac2fae62d"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let state = { projects:[], items:[], activeProject:null };
  function uid(){ return Math.random().toString(36).slice(2,9); }

  // === LOCAL SAVE ===
  function save(){
    localStorage.setItem('pmgr:v1', JSON.stringify(state));
    if (cloud.userId) cloudSyncAll();
  }

  // === FIREBASE SYNC ===
  const cloud = { userId:null, subs:{projects:null, items:{}}, applying:false };
  const colProjects = ()=> db.collection('users').doc(cloud.userId).collection('projects');
  const colItems = (pid)=> colProjects().doc(pid).collection('items');

  async function cloudSyncAll(){
    const projects = state.projects||[], items = state.items||[];
    for(const p of projects){
      await colProjects().doc(p.id).set({id:p.id, name:p.name, notes:p.notes||''},{merge:true});
      const sub = colItems(p.id);
      for(const i of items.filter(x=>x.projectId===p.id))
        await sub.doc(i.id).set(i,{merge:true});
    }
  }

  function applyRemote(projects, itemsByProject){
    cloud.applying = true;
    state.projects = projects;
    state.items = Object.values(itemsByProject).flat();
    if(!state.activeProject && projects[0]) state.activeProject = projects[0].id;
    save();
    renderAll();
    cloud.applying = false;
  }

  function subscribeCloud(){
    cloud.subs.projects && cloud.subs.projects();
    Object.values(cloud.subs.items).forEach(u=>u&&u());
    cloud.subs.items={};
    cloud.subs.projects = colProjects().onSnapshot(snap=>{
      const projs = snap.docs.map(d=>d.data());
      const itemsByP={}; let pending=projs.length;
      if(pending===0){applyRemote([],{});return;}
      projs.forEach(p=>{
        cloud.subs.items[p.id] = colItems(p.id).onSnapshot(s2=>{
          itemsByP[p.id] = s2.docs.map(d=>d.data());
          pending=Math.max(0,pending-1);
          if(pending===0) applyRemote(projs,itemsByP);
        });
      });
    });
  }

  auth.signInAnonymously().catch(console.error);
  auth.onAuthStateChanged(u=>{ if(!u) return; cloud.userId=u.uid; subscribeCloud(); });

  // === UI ===
  const projectList=document.getElementById('projectList');
  const addProject=document.getElementById('addProject');
  const newProjectName=document.getElementById('newProjectName');
  const itemList=document.getElementById('itemList');
  const itemForm=document.getElementById('itemForm');
  const ganttSvg=document.getElementById('ganttSvg');

  function renderProjects(){
    projectList.innerHTML='';
    state.projects.forEach(p=>{
      const d=document.createElement('div');
      d.className='project'+(p.id===state.activeProject?' active':'');
      d.textContent=p.name;
      d.onclick=()=>{state.activeProject=p.id;save();renderAll();};
      projectList.appendChild(d);
    });
  }
  function renderItems(){
    itemList.innerHTML='';
    const items=state.items.filter(i=>i.projectId===state.activeProject);
    items.forEach(i=>{
      const d=document.createElement('div');
      d.className='item';
      d.innerHTML=`<div>${i.title}</div><div>${i.type}</div><div>${i.ps||''}</div><div>${i.pe||''}</div>`;
      itemList.appendChild(d);
    });
  }
  function renderAll(){renderProjects();renderItems();}
  addProject.onclick=()=>{const n=newProjectName.value.trim();if(!n)return;const p={id:uid(),name:n,notes:''};state.projects.push(p);state.activeProject=p.id;save();renderAll();newProjectName.value='';};
  itemForm.onsubmit=e=>{
    e.preventDefault();
    const i={id:uid(),projectId:state.activeProject,title:fTitle.value,type:fType.value,ps:fPs.value,pe:fPe.value};
    state.items.push(i); save(); renderAll(); itemForm.reset();
  };
  renderAll();
</script>
</body>
</html>
